<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ctk: ctk++/ppu/SpeThread.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_97fd2ef747d67336226e943bae25a632.html">ctk++</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_ff673d01075897a7f82d592272773086.html">ppu</a></div>
<h1>SpeThread.hpp</h1><a href="_spe_thread_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * CTK - The Cell Tool Kit Library</span>
<a name="l00003"></a>00003 <span class="comment"> * http://ctk-dev.sourceforge.net/</span>
<a name="l00004"></a>00004 <span class="comment"> * http://cell.fixstars.com/ctk/</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (C) 2006-2008 Fixstars Corp.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * This library is free software; you can redistribute it and/or modify it</span>
<a name="l00009"></a>00009 <span class="comment"> * under the terms of the GNU Lesser General Public License as published by</span>
<a name="l00010"></a>00010 <span class="comment"> * the Free Software Foundation; either version 2.1 of the License,</span>
<a name="l00011"></a>00011 <span class="comment"> * or (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This library is distributed in the hope that it will be useful, but</span>
<a name="l00014"></a>00014 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<a name="l00015"></a>00015 <span class="comment"> * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public</span>
<a name="l00016"></a>00016 <span class="comment"> * License for more details.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * You should have received a copy of the GNU Lesser General Public License</span>
<a name="l00019"></a>00019 <span class="comment"> * along with this library; if not, write to the Free Software Foundation,</span>
<a name="l00020"></a>00020 <span class="comment"> * Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#ifndef _CTK_SPE_THREAD_HPP</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="preprocessor">#define _CTK_SPE_THREAD_HPP</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="ctk__spe__thread_8h.html">ctk_spe_thread.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="_common_8hpp.html">Common.hpp</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "<a class="code" href="_spe_context_8hpp.html">SpeContext.hpp</a>"</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include "<a class="code" href="_spe_image_8hpp.html">SpeImage.hpp</a>"</span>
<a name="l00030"></a>00030 
<a name="l00035"></a>00035 <span class="keyword">namespace </span>ctk {
<a name="l00036"></a>00036 
<a name="l00040"></a><a class="code" href="classctk_1_1_spe_thread.html">00040</a> <span class="keyword">class </span><a class="code" href="classctk_1_1_spe_thread.html">SpeThread</a> : <span class="keyword">public</span> <a class="code" href="classctk_1_1_spe.html">Spe</a> {
<a name="l00041"></a>00041         <a class="code" href="classctk_1_1_spe_image.html">SpeImage</a> m_image;
<a name="l00042"></a>00042         <a class="code" href="ctk__spe__thread_8h.html#129d4e4dbeb3b6fc938309faf786d7b1">ctk_spe_thread_t</a> m_thread;
<a name="l00043"></a>00043         <span class="keywordtype">bool</span> *m_started_p;
<a name="l00044"></a>00044         <span class="keywordtype">int</span> *m_ret_status_p;
<a name="l00045"></a>00045         <a class="code" href="ctk__atomic_8h.html#ba17c79b0f1af4164c5ce5f57424993e">ctk_atomic_ea_t</a> m_thread_counter_ea;
<a name="l00046"></a>00046         <a class="code" href="ctk__atomic_8h.html#ba17c79b0f1af4164c5ce5f57424993e">ctk_atomic_ea_t</a> m_info_counter_ea;
<a name="l00047"></a>00047 
<a name="l00048"></a>00048         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classctk_1_1_spe_thread_group.html">SpeThreadGroup</a>;
<a name="l00049"></a>00049         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classctk_1_1_spe_thread_group_1_1iterator.html">SpeThreadGroup::iterator</a>;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         <span class="keywordtype">void</span> release() {
<a name="l00052"></a>00052             <span class="keywordflow">if</span> (m_thread != NULL &amp;&amp; m_thread_counter_ea != 0) {
<a name="l00053"></a>00053                 <span class="keywordflow">if</span> (_ctk_atomic_dec(m_thread_counter_ea) == 1) {
<a name="l00054"></a>00054                     <span class="comment">// we were the last one</span>
<a name="l00055"></a>00055                     ::ctk_spe_thread_terminate(m_thread);
<a name="l00056"></a>00056                     _ctk_atomic_destroy_local(m_thread_counter_ea);
<a name="l00057"></a>00057                     m_thread = NULL;
<a name="l00058"></a>00058                     m_thread_counter_ea = 0;
<a name="l00059"></a>00059                 }
<a name="l00060"></a>00060             }
<a name="l00061"></a>00061             <span class="keywordflow">if</span> (m_info_counter_ea != 0) {
<a name="l00062"></a>00062                 <span class="keywordflow">if</span> (_ctk_atomic_dec(m_info_counter_ea) == 1) {
<a name="l00063"></a>00063                     <span class="comment">// we were the last one</span>
<a name="l00064"></a>00064                     free(m_started_p);
<a name="l00065"></a>00065                     free(m_ret_status_p);
<a name="l00066"></a>00066                     _ctk_atomic_destroy_local(m_info_counter_ea);
<a name="l00067"></a>00067                     m_info_counter_ea = 0;
<a name="l00068"></a>00068                 }
<a name="l00069"></a>00069             }
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="keywordtype">void</span> alloc() {
<a name="l00073"></a>00073             m_started_p = (<span class="keywordtype">bool</span>*)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>*));
<a name="l00074"></a>00074             m_ret_status_p = (<span class="keywordtype">int</span>*)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>*));
<a name="l00075"></a>00075             *m_started_p = <span class="keyword">false</span>;
<a name="l00076"></a>00076             *m_ret_status_p = 0;
<a name="l00077"></a>00077             _ctk_atomic_create_local(&amp;m_thread_counter_ea);
<a name="l00078"></a>00078             _ctk_atomic_inc(m_thread_counter_ea);
<a name="l00079"></a>00079             _ctk_atomic_create_local(&amp;m_info_counter_ea);
<a name="l00080"></a>00080             _ctk_atomic_inc(m_info_counter_ea);
<a name="l00081"></a>00081         }
<a name="l00082"></a>00082 
<a name="l00084"></a>00084         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<a class="code" href="ctk__spe__thread_8h.html#129d4e4dbeb3b6fc938309faf786d7b1">ctk_spe_thread_t</a> &amp;thread) : m_thread(thread)
<a name="l00085"></a>00085         {
<a name="l00086"></a>00086             m_started_p = (<span class="keywordtype">bool</span>*)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>*));
<a name="l00087"></a>00087             m_ret_status_p = (<span class="keywordtype">int</span>*)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>*));
<a name="l00088"></a>00088             _ctk_atomic_create_local(&amp;m_info_counter_ea);
<a name="l00089"></a>00089             _ctk_atomic_inc(m_info_counter_ea);
<a name="l00090"></a>00090             <span class="keywordflow">if</span> (<a class="code" href="ctk__spe__base_8h.html#806bc6aa8102383295554768801d42ca">ctk_spe_get_status</a>(m_thread) &gt;= <a class="code" href="ctk__spe_8h.html#bed82baf7f470b522273a3e37c24c6007d0f19d71832993f1dc1b55ca1557ffe">CTK_SPE_STATUS_READY</a> &amp;&amp;
<a name="l00091"></a>00091                 <a class="code" href="ctk__spe__base_8h.html#806bc6aa8102383295554768801d42ca">ctk_spe_get_status</a>(m_thread) &lt;= <a class="code" href="ctk__spe_8h.html#bed82baf7f470b522273a3e37c24c60008e0d03a665adf5ffa0bd4effe73e085">CTK_SPE_STATUS_RUNNING</a>)
<a name="l00092"></a>00092                 *m_started_p = <span class="keyword">true</span>;
<a name="l00093"></a>00093             <span class="keywordflow">else</span>
<a name="l00094"></a>00094                 *m_started_p = <span class="keyword">false</span>;
<a name="l00095"></a>00095             m_thread_counter_ea = 0;
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     <span class="keyword">protected</span>:
<a name="l00099"></a>00099         <span class="comment">// implement</span>
<a name="l00100"></a>00100         <span class="keyword">virtual</span> <span class="keyword">const</span> <a class="code" href="ctk__spe_8h.html#70550a2d1068372354f3d8a4b69869ef">ctk_spe_context_t</a>&amp; getInternalContext()<span class="keyword"> const </span>{
<a name="l00101"></a>00101             <span class="keywordflow">if</span> (m_thread == NULL)
<a name="l00102"></a>00102                 <span class="keywordflow">throw</span> Error(<a class="code" href="ctk__error__code_8h.html#99fac1cc7b430245c6159dfdb27afe06">CTK_ERROR_SPE_NOT_RUNNING</a>);
<a name="l00103"></a>00103             <span class="keywordflow">return</span> m_thread-&gt;m_context;
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="keyword">public</span>:
<a name="l00108"></a><a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">00108</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>() : m_image(NULL), m_thread(NULL),
<a name="l00109"></a>00109             m_thread_counter_ea(0), m_info_counter_ea(0) { }
<a name="l00110"></a>00110 
<a name="l00112"></a><a class="code" href="classctk_1_1_spe_thread.html#670eecf03abc996a843571d7eba49e9c">00112</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fname)
<a name="l00113"></a>00113             : m_image(fname), m_thread(NULL), 
<a name="l00114"></a>00114               m_thread_counter_ea(0), m_info_counter_ea(0) { }
<a name="l00115"></a>00115 
<a name="l00117"></a><a class="code" href="classctk_1_1_spe_thread.html#84674eb71eb1e22d2526ae5ad91dc88c">00117</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<a class="code" href="ctk__spe_8h.html#54c80506144287d117b07cd9ce7ed032">ctk_spe_program_t</a> &amp;program)
<a name="l00118"></a>00118             : m_image(program), m_thread(NULL), 
<a name="l00119"></a>00119               m_thread_counter_ea(0), m_info_counter_ea(0) { }
<a name="l00120"></a>00120 
<a name="l00122"></a><a class="code" href="classctk_1_1_spe_thread.html#25d2026733fcea9ffdced7d31f9f33a8">00122</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<a class="code" href="ctk__spe_8h.html#54c80506144287d117b07cd9ce7ed032">ctk_spe_program_t</a> *program)
<a name="l00123"></a>00123             : m_image(*program), m_thread(NULL), 
<a name="l00124"></a>00124               m_thread_counter_ea(0), m_info_counter_ea(0) { }
<a name="l00125"></a>00125 
<a name="l00127"></a><a class="code" href="classctk_1_1_spe_thread.html#a68d82855360e899d7679b7314bf828e">00127</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<a class="code" href="classctk_1_1_spe_image.html">SpeImage</a> &amp;image)
<a name="l00128"></a>00128             : m_image(image), m_thread(NULL), 
<a name="l00129"></a>00129               m_thread_counter_ea(0), m_info_counter_ea(0) { }
<a name="l00130"></a>00130 
<a name="l00132"></a><a class="code" href="classctk_1_1_spe_thread.html#5af41e30930def6471c0c27506a57ef3">00132</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fname, <span class="keywordtype">void</span> *argp, <span class="keywordtype">void</span> *envp, <span class="keywordtype">int</span> flags = 0)
<a name="l00133"></a>00133             : m_image(fname), m_thread(NULL),
<a name="l00134"></a>00134               m_thread_counter_ea(0), m_info_counter_ea(0)
<a name="l00135"></a>00135         {
<a name="l00136"></a>00136             <span class="keywordtype">int</span> ret = ::ctk_spe_thread_create(&amp;m_thread, m_image.<a class="code" href="classctk_1_1_spe_image.html#b5b2e1f3547f0ee6f53436ee85c4ed12">getProgram</a>(),
<a name="l00137"></a>00137                             argp, envp, flags | <a class="code" href="ctk__spe__thread_8h.html#4d891c03babe7103c16cd3871fd97c5c">CTK_SPE_DONT_START</a>);
<a name="l00138"></a>00138             <span class="keywordflow">if</span> (ret != <a class="code" href="ctk__error__code_8h.html#91565920a29823ef6ed5857597365b8e">CTK_SUCCESS</a>)
<a name="l00139"></a>00139                 <span class="keywordflow">throw</span> Error(ret);
<a name="l00140"></a>00140             alloc();
<a name="l00141"></a>00141         }
<a name="l00142"></a>00142 
<a name="l00144"></a><a class="code" href="classctk_1_1_spe_thread.html#bb2832f6c768d89a28d3e849d1fc18b1">00144</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<a class="code" href="ctk__spe_8h.html#54c80506144287d117b07cd9ce7ed032">ctk_spe_program_t</a> &amp;program, <span class="keywordtype">void</span> *argp, <span class="keywordtype">void</span> *envp, 
<a name="l00145"></a>00145             <span class="keywordtype">int</span> flags = 0) : m_image(program), m_thread(NULL),
<a name="l00146"></a>00146               m_thread_counter_ea(0), m_info_counter_ea(0)
<a name="l00147"></a>00147         {
<a name="l00148"></a>00148             <span class="keywordtype">int</span> ret = ::ctk_spe_thread_create(&amp;m_thread, m_image.<a class="code" href="classctk_1_1_spe_image.html#b5b2e1f3547f0ee6f53436ee85c4ed12">getProgram</a>(),
<a name="l00149"></a>00149                             argp, envp, flags | <a class="code" href="ctk__spe__thread_8h.html#4d891c03babe7103c16cd3871fd97c5c">CTK_SPE_DONT_START</a>);
<a name="l00150"></a>00150             <span class="keywordflow">if</span> (ret != <a class="code" href="ctk__error__code_8h.html#91565920a29823ef6ed5857597365b8e">CTK_SUCCESS</a>)
<a name="l00151"></a>00151                 <span class="keywordflow">throw</span> Error(ret);
<a name="l00152"></a>00152             alloc();
<a name="l00153"></a>00153         }
<a name="l00154"></a>00154 
<a name="l00156"></a><a class="code" href="classctk_1_1_spe_thread.html#0718f6ecc3fadbc472543b360cad6de2">00156</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<a class="code" href="classctk_1_1_spe_image.html">SpeImage</a> &amp;image, <span class="keywordtype">void</span> *argp, <span class="keywordtype">void</span> *envp, <span class="keywordtype">int</span> flags = 0) 
<a name="l00157"></a>00157             : m_image(image), m_thread(NULL)
<a name="l00158"></a>00158         {
<a name="l00159"></a>00159             <span class="keywordtype">int</span> ret = ::ctk_spe_thread_create(&amp;m_thread, m_image.<a class="code" href="classctk_1_1_spe_image.html#b5b2e1f3547f0ee6f53436ee85c4ed12">getProgram</a>(),
<a name="l00160"></a>00160                             argp, envp, flags | <a class="code" href="ctk__spe__thread_8h.html#4d891c03babe7103c16cd3871fd97c5c">CTK_SPE_DONT_START</a>);
<a name="l00161"></a>00161             <span class="keywordflow">if</span> (ret != <a class="code" href="ctk__error__code_8h.html#91565920a29823ef6ed5857597365b8e">CTK_SUCCESS</a>)
<a name="l00162"></a>00162                 <span class="keywordflow">throw</span> Error(ret);
<a name="l00163"></a>00163             alloc();
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165 
<a name="l00167"></a><a class="code" href="classctk_1_1_spe_thread.html#a87aaf18decc54012920384d7e50a921">00167</a>         <a class="code" href="classctk_1_1_spe_thread.html#391adc57b71e038ff4c197cc580f75b5">SpeThread</a>(<span class="keyword">const</span> <a class="code" href="classctk_1_1_spe_thread.html">SpeThread</a> &amp;thread) : m_image(thread.m_image), 
<a name="l00168"></a>00168             m_thread(thread.m_thread), m_started_p(thread.m_started_p),
<a name="l00169"></a>00169             m_ret_status_p(thread.m_ret_status_p),
<a name="l00170"></a>00170             m_thread_counter_ea(thread.m_thread_counter_ea),
<a name="l00171"></a>00171             m_info_counter_ea(thread.m_info_counter_ea)
<a name="l00172"></a>00172         {
<a name="l00173"></a>00173             <span class="keywordflow">if</span> (m_thread_counter_ea != 0)
<a name="l00174"></a>00174                 _ctk_atomic_inc(m_thread_counter_ea);
<a name="l00175"></a>00175             <span class="keywordflow">if</span> (m_info_counter_ea != 0)
<a name="l00176"></a>00176                 _ctk_atomic_inc(m_info_counter_ea);
<a name="l00177"></a>00177         }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179         <span class="comment">/* assignment operator */</span>
<a name="l00180"></a>00180         <a class="code" href="classctk_1_1_spe_thread.html">SpeThread</a> &amp;operator=(<span class="keyword">const</span> <a class="code" href="classctk_1_1_spe_thread.html">SpeThread</a> &amp;thread) {
<a name="l00181"></a>00181             <span class="keywordflow">if</span> (m_thread == thread.<a class="code" href="classctk_1_1_spe_thread.html#56100ec81ef05019201b75b7b0f00738">m_thread</a>)
<a name="l00182"></a>00182                 <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00183"></a>00183             release();
<a name="l00184"></a>00184             m_image = thread.<a class="code" href="classctk_1_1_spe_thread.html#9b4a1c05a00a1dc981631a6b6f3eabbf">m_image</a>;
<a name="l00185"></a>00185             m_ret_status_p = thread.<a class="code" href="classctk_1_1_spe_thread.html#14a95bb216cbd1baa250a42c9c352c03">m_ret_status_p</a>;
<a name="l00186"></a>00186             m_started_p = thread.<a class="code" href="classctk_1_1_spe_thread.html#7180568090e7745375d93acc9431b20e">m_started_p</a>;
<a name="l00187"></a>00187             m_thread_counter_ea = thread.<a class="code" href="classctk_1_1_spe_thread.html#57188a80c1e1302f6ca72ccd5b0134d0">m_thread_counter_ea</a>;
<a name="l00188"></a>00188             m_info_counter_ea = thread.<a class="code" href="classctk_1_1_spe_thread.html#d678914b8fb5149578d52afef4ee6c9f">m_info_counter_ea</a>;
<a name="l00189"></a>00189             <span class="keywordflow">if</span> (m_thread_counter_ea != 0)
<a name="l00190"></a>00190                 _ctk_atomic_inc(m_thread_counter_ea);
<a name="l00191"></a>00191             <span class="keywordflow">if</span> (m_info_counter_ea != 0)
<a name="l00192"></a>00192                 _ctk_atomic_inc(m_info_counter_ea);
<a name="l00193"></a>00193             <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195 
<a name="l00197"></a><a class="code" href="classctk_1_1_spe_thread.html#eb30b330d1cdb33972dc623509e82477">00197</a>         <span class="keywordtype">void</span> <a class="code" href="classctk_1_1_spe_thread.html#eb30b330d1cdb33972dc623509e82477">load</a>(<a class="code" href="classctk_1_1_spe_image.html">SpeImage</a> &amp;image) { m_image = image; }
<a name="l00198"></a>00198 
<a name="l00204"></a><a class="code" href="classctk_1_1_spe_thread.html#d4a639b2db563c106946d5c1721091d6">00204</a>         <span class="keywordtype">void</span> <a class="code" href="classctk_1_1_spe_thread.html#d4a639b2db563c106946d5c1721091d6">start</a>(<span class="keywordtype">void</span> *argp = NULL, <span class="keywordtype">void</span> *envp = NULL, <span class="keywordtype">int</span> flags = 0) {
<a name="l00205"></a>00205             <span class="keywordflow">if</span> (m_thread_counter_ea != 0) {
<a name="l00206"></a>00206                 <span class="keywordflow">if</span> (*m_started_p)
<a name="l00207"></a>00207                     <span class="keywordflow">throw</span> Error(<a class="code" href="ctk__error__code_8h.html#b8fb861533ad3bb000bd560d60d0c3df">CTK_ERROR_SPE_ALREADY_RUNNING</a>);
<a name="l00208"></a>00208                 <span class="keywordflow">else</span> {
<a name="l00209"></a>00209                     <span class="keywordtype">int</span> ret = ::ctk_spe_thread_start(m_thread);
<a name="l00210"></a>00210                     <span class="keywordflow">if</span> (ret != <a class="code" href="ctk__error__code_8h.html#91565920a29823ef6ed5857597365b8e">CTK_SUCCESS</a>)
<a name="l00211"></a>00211                         <span class="keywordflow">throw</span> Error(ret);
<a name="l00212"></a>00212                     *m_started_p = <span class="keyword">true</span>;
<a name="l00213"></a>00213                 }
<a name="l00214"></a>00214                 <span class="keywordflow">return</span>;
<a name="l00215"></a>00215             }
<a name="l00216"></a>00216             <span class="keywordtype">int</span> ret = ::ctk_spe_thread_create(&amp;m_thread, 
<a name="l00217"></a>00217                         m_image.<a class="code" href="classctk_1_1_spe_image.html#b5b2e1f3547f0ee6f53436ee85c4ed12">getProgram</a>(), argp, envp,
<a name="l00218"></a>00218                         flags &amp;= ~<a class="code" href="ctk__spe__thread_8h.html#4d891c03babe7103c16cd3871fd97c5c">CTK_SPE_DONT_START</a>);
<a name="l00219"></a>00219             <span class="keywordflow">if</span> (ret != <a class="code" href="ctk__error__code_8h.html#91565920a29823ef6ed5857597365b8e">CTK_SUCCESS</a>)
<a name="l00220"></a>00220                 <span class="keywordflow">throw</span> Error(ret);
<a name="l00221"></a>00221             alloc();
<a name="l00222"></a>00222             *m_started_p = <span class="keyword">true</span>;
<a name="l00223"></a>00223         }
<a name="l00224"></a>00224 
<a name="l00230"></a><a class="code" href="classctk_1_1_spe_thread.html#072653d05793701716b4b19030e9cce1">00230</a>         <span class="keywordtype">void</span> <a class="code" href="classctk_1_1_spe_thread.html#072653d05793701716b4b19030e9cce1">wait</a>(<span class="keywordtype">int</span> *status = NULL) {
<a name="l00231"></a>00231             <span class="keywordflow">if</span> (m_thread_counter_ea == 0)
<a name="l00232"></a>00232                 <span class="keywordflow">throw</span> Error(<a class="code" href="ctk__error__code_8h.html#99fac1cc7b430245c6159dfdb27afe06">CTK_ERROR_SPE_NOT_RUNNING</a>);
<a name="l00233"></a>00233             <span class="keywordtype">int</span> ret = ::ctk_spe_thread_wait(m_thread, m_ret_status_p);
<a name="l00234"></a>00234             <span class="keywordflow">if</span> (ret != <a class="code" href="ctk__error__code_8h.html#91565920a29823ef6ed5857597365b8e">CTK_SUCCESS</a>)
<a name="l00235"></a>00235                 <span class="keywordflow">throw</span> Error(ret);
<a name="l00236"></a>00236             <span class="keywordflow">if</span> (status != NULL)
<a name="l00237"></a>00237                 *status = *m_ret_status_p;
<a name="l00238"></a>00238             _ctk_atomic_destroy_local(m_thread_counter_ea);
<a name="l00239"></a>00239             m_thread_counter_ea = 0;
<a name="l00240"></a>00240             m_thread = NULL;
<a name="l00241"></a>00241             *m_started_p = <span class="keyword">false</span>;
<a name="l00242"></a>00242         }
<a name="l00243"></a>00243 
<a name="l00249"></a><a class="code" href="classctk_1_1_spe_thread.html#eed65fba6fea7636a219ab7617f1d050">00249</a>         <span class="keywordtype">void</span> <a class="code" href="classctk_1_1_spe_thread.html#eed65fba6fea7636a219ab7617f1d050">terminate</a>() {
<a name="l00250"></a>00250             <span class="keywordflow">if</span> (m_thread_counter_ea == 0)
<a name="l00251"></a>00251                 <span class="keywordflow">throw</span> Error(<a class="code" href="ctk__error__code_8h.html#99fac1cc7b430245c6159dfdb27afe06">CTK_ERROR_SPE_NOT_RUNNING</a>);
<a name="l00252"></a>00252             <span class="keywordtype">int</span> ret = ::ctk_spe_thread_terminate(m_thread);
<a name="l00253"></a>00253             <span class="keywordflow">if</span> (ret != <a class="code" href="ctk__error__code_8h.html#91565920a29823ef6ed5857597365b8e">CTK_SUCCESS</a>)
<a name="l00254"></a>00254                 <span class="keywordflow">throw</span> Error(ret);
<a name="l00255"></a>00255             _ctk_atomic_destroy_local(m_thread_counter_ea);
<a name="l00256"></a>00256             m_thread_counter_ea = 0;
<a name="l00257"></a>00257             m_thread = NULL;
<a name="l00258"></a>00258             *m_started_p = <span class="keyword">false</span>;
<a name="l00259"></a>00259             *m_ret_status_p |= (SIGSTOP &gt;&gt; 8);
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261 
<a name="l00265"></a><a class="code" href="classctk_1_1_spe_thread.html#b82f912aee1c929f20cd052bad7e76d0">00265</a>         <span class="keyword">const</span> <a class="code" href="classctk_1_1_spe_context.html">SpeContext</a> <a class="code" href="classctk_1_1_spe_thread.html#b82f912aee1c929f20cd052bad7e76d0">getContext</a>()<span class="keyword"> const </span>{
<a name="l00266"></a>00266             <span class="keywordflow">if</span> (m_thread == NULL)
<a name="l00267"></a>00267                 <span class="keywordflow">throw</span> Error(<a class="code" href="ctk__error__code_8h.html#99fac1cc7b430245c6159dfdb27afe06">CTK_ERROR_SPE_NOT_RUNNING</a>);
<a name="l00268"></a>00268             <span class="keywordflow">if</span> (m_thread-&gt;m_context == NULL) {
<a name="l00269"></a>00269                 <span class="keywordflow">if</span> (m_info_counter_ea == 0 || *m_started_p == <span class="keyword">false</span>)
<a name="l00270"></a>00270                     <span class="keywordflow">throw</span> Error(CTK_ERROR_SPE_NOT_RUNNING);
<a name="l00271"></a>00271                 <span class="keywordflow">else</span> {
<a name="l00272"></a>00272                     <span class="keywordflow">while</span> (<a class="code" href="ctk__spe__base_8h.html#806bc6aa8102383295554768801d42ca">ctk_spe_get_status</a>(m_thread) == <a class="code" href="ctk__spe_8h.html#bed82baf7f470b522273a3e37c24c6007d0f19d71832993f1dc1b55ca1557ffe">CTK_SPE_STATUS_READY</a>)
<a name="l00273"></a>00273                         ;
<a name="l00274"></a>00274                     <span class="keywordflow">if</span> (<a class="code" href="ctk__spe__base_8h.html#806bc6aa8102383295554768801d42ca">ctk_spe_get_status</a>(m_thread) != <a class="code" href="ctk__spe_8h.html#bed82baf7f470b522273a3e37c24c60008e0d03a665adf5ffa0bd4effe73e085">CTK_SPE_STATUS_RUNNING</a>)
<a name="l00275"></a>00275                     {
<a name="l00276"></a>00276                         <span class="keywordflow">throw</span> Error(CTK_ERROR_SPE_NOT_RUNNING);
<a name="l00277"></a>00277                     }
<a name="l00278"></a>00278                 }
<a name="l00279"></a>00279             }
<a name="l00280"></a>00280             <span class="keywordflow">return</span> <a class="code" href="classctk_1_1_spe_context.html">SpeContext</a>(m_thread-&gt;m_context);
<a name="l00281"></a>00281         }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
<a name="l00285"></a><a class="code" href="classctk_1_1_spe_thread.html#798a1f88296907a2ef57e2b01d14158e">00285</a>         <span class="keywordtype">int</span> <a class="code" href="classctk_1_1_spe_thread.html#798a1f88296907a2ef57e2b01d14158e">getExitCode</a>()<span class="keyword"> const </span>{ 
<a name="l00286"></a>00286             <span class="keywordflow">if</span> (m_info_counter_ea == 0)
<a name="l00287"></a>00287                 <span class="keywordflow">throw</span> Error(<a class="code" href="ctk__error__code_8h.html#5a5d426b0a718089bdd650a66a1a022c">CTK_ERROR_SPE_NOT_STARTED</a>);
<a name="l00288"></a>00288             <span class="keywordflow">return</span> <a class="code" href="ctk__spe_8h.html#833cba9f4f865cc60d2bca391a0e9dce">CTK_SPE_EXIT_STATUS</a>(*m_ret_status_p);
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290 
<a name="l00292"></a><a class="code" href="classctk_1_1_spe_thread.html#68b6b543d07fa96d02883a111270d184">00292</a>         <span class="keywordtype">bool</span> <a class="code" href="classctk_1_1_spe_thread.html#68b6b543d07fa96d02883a111270d184">isExited</a>()<span class="keyword"> const </span>{
<a name="l00293"></a>00293             <span class="keywordflow">if</span> (m_info_counter_ea == 0)
<a name="l00294"></a>00294                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00295"></a>00295             <span class="keywordflow">if</span> (m_thread_counter_ea != 0)
<a name="l00296"></a>00296                 <span class="keywordflow">if</span> (<a class="code" href="ctk__spe__base_8h.html#806bc6aa8102383295554768801d42ca">ctk_spe_get_status</a>(m_thread) &lt;= <a class="code" href="ctk__spe_8h.html#bed82baf7f470b522273a3e37c24c60008e0d03a665adf5ffa0bd4effe73e085">CTK_SPE_STATUS_RUNNING</a>)
<a name="l00297"></a>00297                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00298"></a>00298             <span class="keywordflow">return</span> <a class="code" href="ctk__spe_8h.html#dd894e12d70e1e22140f6d08246a35b4">CTK_SPE_IF_EXITED</a>(*m_ret_status_p);
<a name="l00299"></a>00299         }
<a name="l00300"></a>00300 
<a name="l00302"></a><a class="code" href="classctk_1_1_spe_thread.html#667e0e92dba1ecd13ff76dd8e3db46d9">00302</a>         <span class="keyword">virtual</span> <a class="code" href="classctk_1_1_spe_thread.html#667e0e92dba1ecd13ff76dd8e3db46d9">~SpeThread</a>() {
<a name="l00303"></a>00303             release();
<a name="l00304"></a>00304         }
<a name="l00305"></a>00305 }; 
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 }; <span class="comment">// namespace ctk</span>
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 <span class="preprocessor">#endif </span><span class="comment">/* _CTK_SPE_THREAD_HPP */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 28 23:24:39 2010 for ctk by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
